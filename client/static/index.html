<!DOCTYPE html>​
​<html lang="en" ng-app="issues">​
​<head>​
  <meta charset="UTF-8">​
  <title>Neighborhood Watch</title>​
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>​
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>​
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">​
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"/></script>​
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script> 
  <script src="https://maps.googleapis.com/maps/api/js"></script>
  <script type ="text/javascript" src="/socket.io/socket.io.js"></script>

<script type="text/javascript">
  var issues = angular.module('issues', ['ngRoute']);
  issues.config(function($routeProvider){
    $routeProvider
    .when('/',{
        templateUrl: 'partials/login.html'
    })
    .when('/register', {
        templateUrl: 'partials/register.html'
    })
    .when('/home',{
    	templateUrl: 'partials/home.html'
    })
    .when('/chat',{
        templateUrl: 'partials/chat.html'
    });
  });

  issues.controller('SocketController', function ($scope, socket,UserFactory) {
    UserFactory.getUser(function(data){
      $scope.logged_user = data[0].mail;
    });
    $('#message').submit(function (){
      var new_message = $('#new_message').val();
      socket.emit('got_new_message',{name : $scope.logged_user, message : new_message});
      $('#new_message').val("");
      return false;
    });
    socket.on('post_new_message', function (data){
      $("#conversation_board").append("<p>" + data.user + ": " + data.new_message + "</p>");
    });
    socket.on('user_left', function (data){
      $("#conversation_board").append("<p>" + data.name + " has logged out");
    });   

  });

// UserFactory.getIssues(function(data){
//      $scope.issues = data;
// })
//     $scope.login = function(){
//     	UserFactory.login($scope.logged_user, function(output){
//     		$location.path('/home');
//     	});
//     };
//     $scope.addIssue = function(id){
//         //console.log(id);
//     	$scope.new_issue.id = id;
//     	//console.log($scope.new_issue);
//     	UserFactory.addIssue($scope.new_issue,function(){
//             UserFactory.getIssues(function(data){
//                 $scope.issues = data;
//                 $scope.new_issue = {};
//             })
//             .when('/register', {
//                 templateUrl: 'partials/register.html'
//             })
//             .when('/home',{
//                 templateUrl: 'partials/home.html'
//             });
//         });

  issues.controller('UserController', function ($scope,UserFactory,$location){
    $scope.new_comment = {};
    $scope.add_comment ={};
    UserFactory.getUser(function(data){
      $scope.current_user = data[0];
    });

  UserFactory.getIssues(function(data){
    $scope.issues = data;
  });
    $scope.login = function(){
      UserFactory.login($scope.logged_user, function(output){
        $location.path('/home');
      });
    };
    $scope.addIssue = function(id){
        //console.log("addIssue");
        //console.log($scope.new_issue);
      $scope.new_issue.id = id;
      UserFactory.addIssue($scope.new_issue,function(){
        UserFactory.getIssues(function(data){
          $scope.issues = data;
          $scope.new_issue = {};
        });
      });
    };
    $scope.addComment = function(id){
      console.log(id);
      for (var x in $scope.new_comment){
        $scope.add_comment.user = $scope.current_user.mail;
        $scope.add_comment.issueid = x;
        $scope.add_comment.userid = id;
        $scope.add_comment.comment = $scope.new_comment[x].comment;
      }
      UserFactory.addComment($scope.add_comment,function(){
          $scope.new_comment = {};
      //})
     });
    };
    $scope.register = function(){
      if($scope.new_user.password === $scope.new_user.confirmPassword){
        UserFactory.register($scope.new_user,function(output){
          $scope.current_user = output;
          $location.path('/home');
        });
      } else {
        console.log("Passwords doesn't match");
      }
    };
  });

issues.factory('socket',function($rootScope){
  var socket = io.connect();
  return {
    on: function (eventName, callback) {
      socket.on(eventName, function () {  
        var args = arguments;
        $rootScope.$apply(function () {
          callback.apply(socket, args);
        });
      });
    },
    emit: function (eventName, data, callback) {
      socket.emit(eventName, data, function () {
        var args = arguments;
        $rootScope.$apply(function () {
          if (callback) {
            callback.apply(socket, args);
          }
        });
      })
    }
  };    
})


        issues.factory('UserFactory',function($http){
            var factory = {};
            var current_user=[];
            //var address =[];

            factory.getUser = function(callback){
                callback(current_user);
            }

            factory.getIssues = function(callback){
                $http.get('/getIssues').success(function(output){
                    //address.push(output)
                    //console.log(address);
                    callback(output);
                })
            }

            factory.addComment = function(data,callback){
                //console.log(data);
                $http.post('/addComment',data).success(function(output){
                    callback(output);
                })
            }

            factory.login = function(info,callback){
                $http.post('/login',info).success(function(output){
                    //console.log(output);
                    current_user.push(output);
                    callback(output);
                });        
            }

            factory.addIssue = function(data,callback){
                //console.log("factory",data);
                $http.post('/addIssue',data).success(function(output){
                    callback(output);
                })
            }


            factory.register = function(info,callback){
                //console.log(info);
                $http.post('/register',info).success(function(output){
                    //console.log(output);
                    current_user.push(output);
                    //console.log(current_user);
                    callback(output);
                });        
            };

            return factory;
        });
       </script>
</head>
<body>
</body>
</html>
<div ng-view="">
</div>
